package com.mth.Ferrari;

import android.app.Activity;
import android.graphics.Color;
import android.os.Bundle;
import android.os.StrictMode;
import android.util.Log;
import android.view.View;
import android.widget.Button;
import android.widget.TextView;
import android.widget.Toast;

import cz.msebera.android.httpclient.HttpEntity;
import cz.msebera.android.httpclient.client.config.RequestConfig;
import cz.msebera.android.httpclient.client.methods.CloseableHttpResponse;
import cz.msebera.android.httpclient.client.methods.HttpPost;
import cz.msebera.android.httpclient.entity.StringEntity;
import cz.msebera.android.httpclient.impl.client.CloseableHttpClient;
import cz.msebera.android.httpclient.impl.client.HttpClients;
import cz.msebera.android.httpclient.util.EntityUtils;

import org.json.JSONException;
import org.json.JSONObject;

public class IPInput extends Activity {

    private TextView mStatus;
    private TextView Switch, go, speedup, left, back, right;


    private boolean flag_singleSend = true;

    private boolean flag_start = false;
    private boolean flag_go = false;
    private boolean flag_speedup = false;
    private boolean flag_left = false;
    private boolean flag_back = false;
    private boolean flag_right = false;

    private int status_marker = 0 ;

    private JSONObject myjson = new JSONObject();

    private String TAG = "MTH_Morgan";


    //    private String myUrl="http://10.11.8.16:5000/myCar";
//    private String myUrl="http://192.168.0.100:5000/myCar";
    private String myUrl;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_ip);

        mStatus = (TextView) findViewById(R.id.mystatus);

        //android.os.NetworkOnMainThreadException-->W/System.err: android.os.NetworkOnMainThreadException
        if (android.os.Build.VERSION.SDK_INT > 9) {
            StrictMode.ThreadPolicy policy = new StrictMode.ThreadPolicy.Builder().permitAll().build();
            StrictMode.setThreadPolicy(policy);
        }

        String IP = getIntent().getStringExtra("ip_address");
        myUrl = "http://" + IP +":5000/myFerrari";
        Log.e(TAG+"myipaddress", myUrl);

        new Thread(readThread).start();

        final Button Switch = findViewById(R.id.Switch);
        Switch.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                flag_go = false;
                flag_speedup = false;
                flag_right = false;
                flag_back = false;
                flag_left = false;

                Covert();
                if(!remote(myjson)){
                    Toast.makeText(getApplicationContext(),"Command not Send",Toast.LENGTH_SHORT).show();
                }
            }
        });



        final Button go = findViewById(R.id.GO);
        go.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                flag_go = true;
                flag_speedup = false;
                flag_left = false;
                flag_back = false;
                flag_right = false;

                Covert();
                if(!remote(myjson)){
                    Toast.makeText(getApplicationContext(),"Command not Send",Toast.LENGTH_SHORT).show();
                }
            }
        });



        final Button speedup = findViewById(R.id.ACCELERATOR);
        speedup.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                flag_go = true;
                flag_speedup = true;
                flag_left = false;
                flag_back = false;
                flag_right = false;

                Covert();
                if(!remote(myjson)){
                    Toast.makeText(getApplicationContext(),"Command not Send",Toast.LENGTH_SHORT).show();
                }
            }
        });


        final Button left = findViewById(R.id.LEFT);
        left.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                flag_go = true;
                flag_speedup = false;
                flag_left = true;
                flag_back = false;
                flag_right = false;

                Covert();
                if(!remote(myjson)){
                    Toast.makeText(getApplicationContext(),"Command not Send",Toast.LENGTH_SHORT).show();
                }
            }
        });


        final Button back = findViewById(R.id.BACK);
        back.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                flag_go = false;
                flag_speedup = false;
                flag_left = false;
                flag_back = true;
                flag_right = false;

                Covert();
                if(!remote(myjson)){
                    Toast.makeText(getApplicationContext(),"Command not Send",Toast.LENGTH_SHORT).show();
                }
            }
        });


        final Button right = findViewById(R.id.RIGHT);
        right.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                flag_go = true;
                flag_speedup = false;
                flag_left = false;
                flag_back = false;
                flag_right = true;

                Covert();
                if(!remote(myjson)){
                    Toast.makeText(getApplicationContext(),"Command not Send",Toast.LENGTH_SHORT).show();
                }
            }
        });
    }

    public void Covert() {
        String str = "";
        try {
            if (flag_start) str = str + '1';
            else str = str + '0';

            if (flag_go) str = str + '1';
            else str = str + '0';

            if (flag_speedup) str = str + '1';
            else str = str + '0';

            if (flag_left) str = str + '1';
            else str = str + '0';

            if (flag_back) str = str + '1';
            else str = str + '0';

            if (flag_right) str = str + '1';
            else str = str + '0';
//
            myjson.put("data", str);
        } catch (JSONException jsonException) {
            jsonException.printStackTrace();
        }
    }


    public boolean remote(JSONObject JsonStr){
        try{
            while(flag_singleSend){
                flag_singleSend = false;
//            myjson.put("data","data");
//            myjson.put("flag_go",flag_go);
//            myjson.put("flag_speedup",flag_speedup);
//            myjson.put("flag_left",flag_left);
//            myjson.put("flag_back",flag_back);
//            myjson.put("flag_right",flag_right);
                Log.e(TAG+"---ready",  String.valueOf(JsonStr));
                String SendResponse = DocHessianServiceTest.sendHttpPost(myUrl, JsonStr.toString());
                Log.e(TAG+"---send",  String.valueOf(JsonStr));
                Log.e(TAG+"---receive",  String.valueOf(SendResponse));
                if (SendResponse.equals("ACK")) {
                    Log.e(TAG + "---changelabel", "changing online");
                    mStatus.setText("Device On-line");
                    mStatus.setBackgroundColor(Color.GREEN);
                }
                flag_singleSend = true;
            }
            status_marker = 0;
            return true;

        } catch (Exception e) {
            flag_singleSend = true;
            Log.e(TAG+"Exception error",  String.valueOf(e));
            status_marker ++;
            if(status_marker>5){
                if (String.valueOf(e).contains("failed to connect to") | String.valueOf(e).contains("timed out")) {
                    Log.e(TAG + "---changelabel", "changing offline");
                    mStatus.setText("Device Off-line");
                    mStatus.setBackgroundColor(Color.YELLOW);
                }
                status_marker = 0;
            }
            e.printStackTrace();
        }
        return false;
    }



    //thread
    Runnable readThread = new Runnable() {
        @Override
        public void run() {
            JSONObject mytest = new JSONObject();

            while (true) {
            try {
                mytest.put("data", "0");
                if(flag_singleSend){
                    remote(mytest);
                    Thread.sleep(1000);
                }
            } catch (JSONException | InterruptedException e) {
                e.printStackTrace();
            }
        }
        }
    };


    //for websocket post
    public static class DocHessianServiceTest {
        public static String sendHttpPost(String url, String regJson) throws Exception {
            CloseableHttpClient httpClient = HttpClients.createDefault();
            RequestConfig requestConfig = RequestConfig.custom().setConnectionRequestTimeout(1000)
                    .setSocketTimeout(1000).setConnectTimeout(1000).build(); //set the timeout

            HttpPost httpPost = new HttpPost(url);
            httpPost.setConfig(requestConfig);
            Log.e("MTH_Morgan 111",  String.valueOf(httpPost));
            httpPost.addHeader("Content-Type", "application/json");
            httpPost.setEntity(new StringEntity(regJson,"UTF-8")); //防止中文乱码

            CloseableHttpResponse response = httpClient.execute(httpPost);
//            System.out.println(response.getStatusLine().getStatusCode() + "\n");
            Log.e("MTH_Morgan222",  String.valueOf(response));
            Log.e("MTH_Morgan333",  String.valueOf(response.getStatusLine()));
            Log.e("MTH_Morgan444",  String.valueOf(response.getStatusLine().getStatusCode()));
            HttpEntity entity = response.getEntity();
            String responseContent = EntityUtils.toString(entity, "UTF-8");
//            System.out.println(responseContent);
            Log.e("MTH_Morgan555",  String.valueOf(responseContent));

            response.close();
            httpClient.close();
            return responseContent;
        }
    }
}
